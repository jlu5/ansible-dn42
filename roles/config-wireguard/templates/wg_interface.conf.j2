# Generated by ansible-dn42, do not edit!
{% set ifname = peer_info['name'] %}
{% if 'local_v6' in peer_info %}
    {%- set local_v6 = peer_info['local_v6'] %}
{# Automatically determine whether we're peering over link-local v6 or ULA #}
{% elif peer_info.get('peer_v6') and peer_info['peer_v6'].startswith('fe80:') %}
    {%- set local_v6 = link_local_ip6 %}
{% else %}
    {%- set local_v6 = ownip6 %}
{% endif %}

{%- set local_v4 = peer_info.get('local_v4', ownip) %}
{% if peer_info.get('is_internal_node') %}
{%- set local_v4 = link_local_ip4 %}
{% endif %}
{# Rewrite single IP addresses as a /32, but leave netblocks of other sizes as is #}
{% if local_v4 | ansible.utils.ipaddr('address') %}
{% set local_v4 = local_v4 | ansible.utils.ipaddr('host') %}
{% endif %}

auto {{ ifname }}
iface {{ ifname }} inet static
    address {{ local_v4 }}
{% if peer_info.get('peer_v4') %}
    pointopoint {{ peer_info['peer_v4'] }}
{% endif %}
{% if 'wg_mtu' in peer_info %}
    mtu {{ peer_info['wg_mtu'] }}
{% endif %}
    pre-up ip link add {{ ifname }} type wireguard
    pre-up wg set {{ ifname }} listen-port {{ peer_info['port'] }} private-key {{ peer_info.get('wg_privkey', "/etc/wireguard/privatekey") }}
{% for curr_peer in peer_info.get('multi', [peer_info]) %}
    pre-up wg set {{ ifname }} peer {{ curr_peer['wg_pubkey'] }} allowed-ips {{ curr_peer.get('wg_allowedips', "0.0.0.0/0,::/0") }}
{% if curr_peer.get('wg_presharedkey') %}
{% set _wg_psk_config_str = "wg set " + (ifname | quote) + " peer " + (curr_peer['wg_pubkey'] | quote) + " preshared-key <(echo " + (curr_peer['wg_presharedkey'] | quote) + ")" %}
    pre-up bash -c {{ _wg_psk_config_str | quote }}
{% endif %}
{% if curr_peer.get('remote') %}
    pre-up timeout 5 wg set {{ ifname }} peer {{ curr_peer['wg_pubkey'] }} endpoint {{ curr_peer['remote'] }}
{% endif %}
{% endfor %}

{% if peer_info.get('peer_v6') %}
    post-up ip -6 addr add {{ local_v6 }} peer {{ peer_info['peer_v6'] }} dev {{ ifname }}
{% elif peer_info.get('local_v6') %}
    post-up ip -6 addr add {{ local_v6 }} dev {{ ifname }}
{% endif %}
{% for local_v6 in peer_info.get('local_v6_multi', []) %}
    post-up ip -6 addr add {{ local_v6 }} dev {{ ifname }}
{% endfor %}
{# Disable Martian filtering for local addresses, as we may be forwarding responses for anycast services from another node #}
    post-up sysctl -w net.ipv4.conf.{{ ifname }}.accept_local=1
{% if dn42_ratelimit and ifname.startswith('dn42') %}
    post-up tc qdisc add dev {{ ifname }} {{ dn42_ratelimit_tc_args }}
{% endif %}
    post-down ip link del {{ ifname }}
