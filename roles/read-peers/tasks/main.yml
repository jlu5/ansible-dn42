- name: Read Wireguard settings for peers
  include_vars:
    file: "{{ playbook_dir }}/roles/config-wireguard/config/{{ inventory_hostname }}.yml"
  ignore_errors: true

- name: Read GRE settings for peers
  include_vars:
    file: "{{ playbook_dir }}/roles/config-gre-plain/config/{{ inventory_hostname }}.yml"
  ignore_errors: true

# This is already read in once as part of group_vars/all, but the values may have been changed
# by scripts/enumerate-igp-tunnels.py: pre_tasks still run after enumerating facts the first time
- name: Read IGP tunnel settings
  include_vars:
    file: "global-config/igp-tunnels.yml"

- name: Instantiate lists of WireGuard tunnels
  set_fact:
    wg_peers: "{{ wg_peers | default([]) }}"
    wg_peers_internal: []

- name: Compute WireGuard tunnels to update (internal nodes)
  set_fact:
    wg_peers_internal: "{{ wg_peers_internal + [peer_info] }}"
  loop: "{{ igp_neighbours.get(inventory_hostname, []) | sort }}"
  loop_control:
    loop_var: igp_node
  vars:
    peer_info:
      name: "igp-{{ igp_node }}"
      port: "{{ igp_wg_ports[inventory_hostname][igp_node] }}"
      remote: "{{ lookup('serverhost', igp_node) }}:{{ igp_wg_ports[inventory_hostname][igp_node] }}"
      wg_pubkey: "{{ hostvars[igp_node]['wg_pubkey'] }}"
      peer_v4: "{{ hostvars[igp_node]['link_local_ip4'] }}"
      peer_v6: "{{ hostvars[igp_node]['link_local_ip6'] }}"
      priority: 10
      is_internal_node: true

- name: Combine list of WireGuard tunnels to update
  set_fact:
    # Template internal nodes before peers
    wg_peers_all: "{{ wg_peers_internal + wg_peers }}"
