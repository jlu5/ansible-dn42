# Generated by Ansible
{% macro ibgp_link(host, is_rr_downstream=False, is_rr_upstream=False) -%}
protocol bgp ibgp_{{ host | replace("-", "_") }} {
    local as {{ ownas }};
    neighbor {{ hostvars[host]['ownip6'] }} as {{ ownas }};
    source address {{ ownip6 }};
{% if is_rr_upstream %}
{# The upstream marks the downstream as an rr client, not the other way around #}
    rr client;
{% endif %}
    advertise hostname on;

    ipv4 {
        import where ibgp_import_filter();
{% if is_rr_downstream %}
{# Avoid exporting routes *from* private servers - internal services are routed using Babel #}
        export none;
{% else %}
        export where ibgp_export_filter();
{% endif %}
        next hop address {{ ownip }};
        next hop self;
    };

    ipv6 {
        import where ibgp_import_filter();
{% if is_rr_downstream %}
        export none;
{% else %}
        export where ibgp_export_filter();
{% endif %}
        next hop address {{ ownip6 }};
        next hop self;
    };
}
{%- endmacro %}

{# Template RR upstreams for (private) servers not in iBGP mesh #}
{% if ibgp_rr_upstreams is defined %}
{% for host in ibgp_rr_upstreams %}
{{ ibgp_link(host, is_rr_downstream=True) }}
{% endfor %}
{% else %}
{# Template iBGP peers - always a mesh for dn42 routers #}
{% for host in groups['dn42routers'] %}
{% if host != inventory_hostname %}
{{ ibgp_link(host) }}
{% endif %}
{% endfor %}
{# Template downstream private nodes (always RR clients).
   These sessions are used to provide connectivity to segments not routed via Babel,
   such as YVRLAB and Anycast DNS #}
{% for host in groups['private'] %}
{% if inventory_hostname in hostvars[host].get('ibgp_rr_upstreams', []) %}
{{ ibgp_link(host, is_rr_upstream=True) }}
{% endif %}
{% endfor %}
{% endif %}
